// src/components/planet/PlanetBase.jsx
import { usePlanetContext } from '@/planetData/PlanetContext';
import { areaData } from '@/planetData/areaData';
console.log(areaData.filter((area) => !Array.isArray(area.position)));

import { useTexture } from '@react-three/drei';
import * as THREE from 'three';

import AreaTrigger from './AreaTrigger';

export default function PlanetBase({ activeSector = null, setActiveSector }) {
  const { planetState, setActiveArea } = usePlanetContext();
  const sectionTexture = useTexture('/images/planet/planet_cross_section.webp');

  // â›“ï¸ ä½ç½®è£œæ­£é–¢æ•°ï¼ˆæ±ç”¨åŒ–ï¼‰
  const applyOffset = (position, offset = [-0.1, -1.9, 0]) => {
    if (!Array.isArray(position)) return [0, 0, 0]; // â† å®‰å…¨ãªåˆæœŸå€¤
    return position.map((v, i) => v + offset[i]);
  };

  // âš ï¸ contextæœªå–å¾—æ™‚ã®æ—©æœŸçµ‚äº†
  if (!planetState) return null;

  // âœ… fallbackæ§‹é€ ï¼ˆmapå†…ã§å‚ç…§ï¼‰
  const fallbackState = {
    theme: 'light',
    glowEnabled: false,
  };

  return (
    <group>
      {/* ğŸ”† ç©ºé–“å…‰æº */}
      <ambientLight intensity={0.6} />
      <pointLight intensity={1.0} position={[4, 4, 4]} />

      {/* ğŸª Planetæ–­é¢å›³ */}
      <mesh rotation={[-Math.PI / 2, 0, Math.PI]} scale={[5.2, 5.2, 1]}>
        <planeGeometry args={[3, 3]} />
        <meshBasicMaterial
          transparent={true}
          color="white"
          map={sectionTexture}
          opacity={1.0}
          side={THREE.DoubleSide}
        />
      </mesh>

      {/* ğŸ§­ ãƒˆãƒªã‚¬ãƒ¼è¡¨ç¤º */}
      {areaData.map(({ id, name, position, sector }) => {
        if (!Array.isArray(position)) return null; // â† ã“ã“ã§ä¸æ­£ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼

        // âœ… fallbacké©ç”¨ï¼ˆå¿…ãšæç”»æ§‹é€ ã«å€¤ãŒå…¥ã‚‹ï¼‰
        const visual = planetState[id] ?? fallbackState;

        // ğŸ’¡ ã‚»ã‚¯ã‚¿ãƒ¼åˆ¶å¾¡
        if (activeSector !== null && sector !== activeSector) return null;

        const finalPosition = applyOffset(position);

        return (
          <AreaTrigger
            key={id}
            id={id}
            label={name}
            position={finalPosition}
            theme={visual.theme}
            glowEnabled={visual.glowEnabled}
            onClick={() => {
              setActiveArea(id); // Contextæ›´æ–°
              setActiveSector?.(id); // â† ã“ã‚Œã‚’è¿½åŠ ï¼ãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤ºç”¨ã®ãƒˆãƒªã‚¬ãƒ¼
            }}
          />
        );
      })}
    </group>
  );
}
